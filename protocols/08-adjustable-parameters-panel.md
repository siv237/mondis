# Протокол 08 — Панель регулируемых параметров (аппаратные и программные)

Статус: TODO

Цель (коротко): предоставить единую панель во вкладке «Подробности» карточки монитора для управления всеми доступными параметрами изображения. Сначала аппаратные регуляторы по DDC/CI (если поддерживаются дисплеем), затем программные методы (XRandR/гамма) с учётом ограничений окружения. Обеспечить единый UX, подтверждение/откат изменений и персистентность настроек по каждому дисплею/методу.

## Область
- Платформы: Linux, первично X11. Wayland — ограниченно, при наличии альтернатив.
- Дисплеи: внешние мониторы/панели с DDC/CI; встроенные — по возможности (некоторые лэптопы не проксируют DDC).
- Методы:
  - Аппаратные (DDC/CI, VCP): яркость, контраст, предустановки цветовой температуры/цветовых профилей, канальные усиления RGB и т.п. — строго по поддержке конкретного устройства.
  - Программные (XRandR/гамма): «логическая» яркость/гамма/баланс по выходу, пресеты.

## Этапы реализации

### Этап 1 — Аппаратные регуляторы (DDC/CI)
- Детект возможностей:
  - Парсить capabilities/VCP список через `ddcutil capabilities`/`getvcp` для конкретного дисплея.
  - Собрать карту поддерживаемых кодов VCP и их диапазоны/перечисления.
- Целевые VCP (примерный ориентир, включать только если поддерживаются):
  - 0x10 Brightness (яркость)
  - 0x12 Contrast (контраст)
  - 0x14 Select Color Preset (sRGB/6500K/9300K и др. — перечислимые значения)
  - 0x16/0x18/0x1A RGB Gain (усиления по каналам)
  - Прочие популярные коды — опционально, по устройству
- UI/UX:
  - Во вкладке «Подробности» отрисовывать секцию «Аппаратные» с набором слайдеров/комбобоксов только для реально поддерживаемых параметров.
  - Бейдж метода «DDC» и подсказки с текущими VCP значениями.
  - Дебаунс отправки команд; обработка ошибок с видимой индикацией.
- Безопасность и подтверждение:
  - Интеграция с уже существующим механизмом подтверждения/отката (Протокол 02): применение пачки изменений с таймером; при отмене — восстановление «оригиналов» (значений до начала сессии).
- Персистентность:
  - В `~/.config/mondis/settings.json` хранить `control_prefs` (метод на дисплей) и `last_values_ddc` (последние VCP значения по дисплею/коду), не ломая существующие поля.

### Этап 2 — Программные регуляторы (XRandR/гамма)
- Возможности XRandR:
  - Параметры `--brightness` (мультипликативный фактор) и `--gamma R:G:B` на уровне вывода.
  - Предупреждать, что это пост‑обработка и может отличаться от аппаратной регулировки.
- Wayland:
  - Ограничения: отсутствует прямой доступ к RandR; рассмотреть compositor‑специфичные средства (например, `wlr-randr`) при наличии.
- UI/UX:
  - Секция «Программные» с слайдером яркости и тремя слайдерами/комбинированным контролом гаммы (или предустановками: По умолчанию, Тёплая, Холодная и т.п.).
  - Бейдж метода «XRandR» и заметная маркировка «программно».
- Подтверждение/откат:
  - Аналогично аппаратному этапу, с фиксацией «оригиналов» и возвратом.
- Персистентность:
  - Расширить `settings.json`: `last_values_xrandr` (brightness, gamma RGB по выходу), совместимо с имеющимися полями.

## Интеграция в UI (вкладка «Подробности»)
- Структура:
  - Блок «Аппаратные (DDC)»: динамически сгенерированный набор контролов по поддерживаемым VCP.
  - Блок «Программные (XRandR)»: яркость/гамма/пресеты.
  - Переключение предпочтительного метода (если доступны оба) — уже поддерживается в карточке; распространить на новые параметры.
- Стили/поведение:
  - Единые классы CSS для слайдеров/бейджей; disabled‑состояние для неподдерживаемых.
  - Tooltip’ы с текущими значениями и диапазонами.

## Данные и персистентность
- Дополнить `settings.json`:
  - `last_values_ddc`: `{ display_id -> { vcp_code -> value } }`
  - `last_values_xrandr`: `{ output_name -> { brightness, gamma: {r,g,b} } }`
  - Совместимость: не изменять существующие поля, аккуратная миграция при чтении.

## MVP‑этапы
1) DDC авто‑детект поддерживаемых VCP, чтение/установка 0x10/0x12/0x14, базовый UI + подтверждение.
2) Расширение до RGB Gain (0x16/0x18/0x1A), сохранение `last_values_ddc`.
3) XRandR яркость + гамма, пресеты, сохранение `last_values_xrandr`.
4) Полировка UI, бейджи методов, улучшенные сообщения об ошибках и логирование.

## Риски и ограничения
- Неодинаковая поддержка VCP у производителей; некоторые коды могут отсутствовать или вести себя нестабильно.
- Wayland может не позволить программную регулировку; различия между DE/композиторами.
- Конкуренция с другими инструментами, изменяющими гамму/яркость (цветокоррекция, энергосбережение).

## Тесты и верификация
- DDC: детект VCP, чтение/запись, корректный откат значений, стабильность при быстрых изменениях (дебаунс).
- XRandR: применение `--brightness/--gamma`, проверка возврата к исходным, отсутствие зависаний и артефактов.
- Персистентность: загрузка/сохранение настроек между рестартами, совместимость с прежними версиями.

## Хронология изменений
- 2025-08-30 12:07 (+10:00): Создан протокол, определены цели, этапы (аппаратный/программный), UI/UX во вкладке «Подробности», данные, MVP, риски и тесты.
