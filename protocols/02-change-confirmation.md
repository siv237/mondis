# Протокол 02 — Система подтверждения изменений

Статус: DONE

Цель: безопасное изменение настроек с возможностью отката.

Сделано:
- Таймер 20 сек, кнопки подтверждения/отмены, автооткат.
- Восстановление состояния слайдеров, сохранение профиля в XML.
- Защита от рекурсивных событий UI, адаптивные цвета и перезапуск таймера.

Примечания:
- См. соответствующие компоненты в `crates/mondis-panel*/`.

## Хронология изменений

- 2025-08-29 23:04 (+10:00): Панель подтверждения переведена в нижний плавающий оверлей.
  - Использованы `gtk::Overlay` + `gtk::Revealer` — панель появляется поверх контента снизу, не сдвигая основной layout.
  - Таймер обратного отсчёта 20 сек: текст обновляется каждую секунду, по тайм-ауту значения яркости откатываются, слайдеры восстанавливаются.
  - Обработчики Confirm/Cancel теперь скрывают панель через `confirm_revealer.set_reveal_child(false)` и корректно сохраняют/откатывают профиль.
  - Рефактор замыканий: `start_confirmation_timer` обёрнут в `Rc<dyn Fn(Vec<DisplayInfo>)>`, внутри timeout-замыкания используется клон `confirm_revealer` для исключения ошибок перемещения (`E0507`).

- 2025-08-30 00:17 (+10:00): Персистентность позиций слайдеров и независимость значений для DDC/XRandR.
  - При старте приложения загружаются `UiSettings` из `~/.config/mondis/settings.json`, восстанавливаются:
    - `control_prefs` (предпочтение метода по шине `i2c_bus`),
    - `last_values_ddc` и `last_values_xrandr` (последние значения яркости отдельно по методу).
  - Инициализация ряда монитора использует сохранённое предпочтение, если поддерживается данным дисплеем; иначе — выбирает доступный метод.
  - При первичном чтении яркости с устройства «оригинал» сохраняется для механизма подтверждения, но в UI отображается сохранённое последнее значение для выбранного метода (если есть), сохраняя независимость методов.
  - По изменению значения или переключению метода настройки асинхронно сохраняются через `save_settings_from_state()`.

- 2025-09-05 20:31 (+10:00): Панель подтверждения перенесена наверх.
  - `gtk::Revealer` выровнен по верхнему краю (`valign = Start`), анимация изменена на `SlideDown`.
  - В CSS у `.confirm-bar` заменён `margin-bottom` на `margin-top` для корректного отступа при наложении сверху.
  - Визуально панель теперь выпадает сверху поверх контента, не сдвигая основной layout, как и ранее.
