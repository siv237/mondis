# Протокол 07 — Включение телевизоров по HDMI/DisplayPort

Статус: TODO

Цель: предоставить в панели и трее управление питанием внешних дисплеев/телевизоров:
- HDMI-CEC: включение/выключение ТВ, выбор активного источника (Input/Active Source).
- DPMS: программное включение/выключение видеовыходов (для мониторов/панелей без CEC или на DisplayPort).

## Область
- Поддержка Linux/X11 в первой итерации (Wayland — по возможности через совместимые утилиты).
- Независимость по выходам (multi-GPU/несколько коннекторов).
- Персистентность предпочтительного способа управления и последнего состояния.

## Подход
- HDMI-CEC:
  - Использовать системные средства: `cec-client` (libcec) или доступ к `/dev/cec*` через утилиты `cec-ctl` (v4l2-ctl/cec-utils). Первая итерация — shell-вызовы, затем возможно FFI к libcec.
  - Базовые команды: включение (Image View On, 0x04) и активный источник (Active Source, 0x82); выключение (Standby, 0x36).
  - Обнаружение адаптеров: перечислить `/dev/cec*`, считать физические адреса и связать с видео‑выходами.
- DPMS (X11):
  - `xrandr --output <NAME> --off` / `--auto` (или `--mode`), для логического выключения/включения вывода.
  - На Wayland — ограниченно; можно предложить альтернативы (например, `wlr-randr`) или пометить как «не поддерживается».

## UI/UX
- В панели напротив каждого выхода: кнопка питания (иконка), tooltip с выбранным методом (CEC/DPMS) и результатом.
- В трее — быстрые действия: «Включить ТВ», «Выключить ТВ» по конкурентно‑выбранным целям.
- Настройки: выбор метода по выходу (если доступны оба), сохранение предпочтения.

## Данные и персистентность
- В `settings.json` добавить раздел `power_prefs`: карта `output -> {method: "cec"|"dpms", target: cec_addr/dev}` и `last_power_state`.
- Совместимость: не ломать существующие поля (`control_prefs`, `last_values_*`).

## Права и зависимости
- Доступ к `/dev/cec*` может требовать группы (например, `video`/`input`) — документировать в установке.
- Зависимости опционально: `cec-utils` (или libcec), `xrandr`.

## Риски
- Не все ТВ корректно реагируют на CEC; возможны расхождения производителей.
- Трудность маппинга `Xrandr output` -> физический адрес CEC (особенно через ресиверы/матрицы).
- Wayland ограничения для DPMS.
- Конкуренция с DE/Power Manager.

## MVP‑этапы
1. Детект `/dev/cec*`, пробный `cec-client`/`cec-ctl` включение/выключение одного ТВ.
2. Кнопка питания в панели для HDMI‑выходов; сохранение предпочтения метода.
3. DPMS через `xrandr` для DisplayPort/HDMI без CEC.
4. Трей‑экшены для быстрого включения/выключения выбранных выходов.
5. Обработка ошибок/логирование; видимый статус в UI.

## Тесты
- Наличие устройств `/dev/cec*`; успешная отправка `Image View On` и `Standby` в логах.
- Переключение `xrandr --off/--auto` без зависаний; восстановление режима.
- Персистентность настроек между рестартами.

## Хронология изменений
- 2025-08-30 00:17 (+10:00): Создан протокол, определены цели, подходы (CEC/DPMS), риски, MVP‑этапы и требования к данным/правам.
