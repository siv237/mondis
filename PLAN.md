# Mondis: план разработки (итерации маленькими шагами)

Цель: кросс-DE трей-приложение на Rust для управления многомониторной системой (раскладка, масштаб, профили) и физическими параметрами мониторов (DDC/CI: яркость, цветовая температура). Поддержка X11 (RandR) и поэтапное добавление Wayland (GNOME Mutter).

Обозначения статуса: [TODO] не начато · [WIP] в работе · [DONE] готово · [HOLD] отложено · [DROP] удалено

## Нулевой тестовый план: Панель яркости [DONE]
- Цель: быстро обкатать концепцию на отдельном окне-панели без трея.
- Результат: окно с перечнем обнаруженных мониторов и слайдером яркости для каждого монитора, поддерживающего DDC (VCP 0x10). Неподдерживаемые отображаются как «не поддерживается».
- Технологии: Rust + GTK (gtk4-rs или gtk3-rs), асинхронные вызовы `ddcutil` (CLI) через `tokio::process`.
- Действия:
  - Модуль обнаружения мониторов: чтение EDID и базовой информации (X11: RandR), сопоставление с ddcutil (по EDID/серийнику).
  - Модуль DDC (минимум): `getvcp 0x10` и `setvcp 0x10 <value>`.
  - UI: вертикальный список «Имя монитора — [слайдер яркости]»; кнопка «Обновить», индикатор состояния/ошибок.
  - Обработка ошибок: таймауты, недоступность i2c/dev, отсутствие поддержки VCP.
- Проверка:
  - Значение яркости читается и изменяется на поддерживаемых мониторах; на остальных — корректный статус.
  - Изменение через слайдер отдаёт команду и UI синхронизируется с реальным значением.
- Примечания:
  - Это вспомогательное приложение/бинарь (например, `mondis-panel`) только для отработки UX и DDC-потока. После встраивания в трэй может быть оставлено как отдельный инструмент.

## Этап 0. База проекта [TODO]
- Инициализировать Rust workspace (crates: `mondis-core`, `mondis-tray`, `mondis-cli`, `mondis-x11`, `mondis-ddc`; позже `mondis-wayland`, `mondis-app`).
- Инфраструктура: rustfmt, clippy, logging (`tracing`), errors (`thiserror`), конфиги (serde + toml), базовый CI (fmt/clippy/test).
- Проверка: `cargo build`/`cargo test` локально, логи пишутся.
- Примечания:

## Этап 1. Простейший трей [TODO]
- Иконка в трее + меню: «About», «Quit». Библиотека: `tray-icon` или `ksni`.
- Проверка: иконка видна в GNOME/KDE/XFCE (в GNOME через AppIndicator), пункты меню работают.
- Примечания:

## Этап 2. Чтение дисплеев (X11, только чтение) [TODO]
- `mondis-x11`: x11rb + RandR. Получать: outputs, EDID, физ. размеры, текущий режим, позиция, применённый scale.
- В трей-меню показать «Информация о дисплеях» (read-only).
- Проверка: сверка с `xrandr --query`; корректная обработка нескольких мониторов.
- Примечания:

## Этап 3. DDC: обнаружение и чтение яркости (CLI ddcutil) [TODO]
- `mondis-ddc`: вызывать `ddcutil getvcp 0x10`, сопоставлять мониторы по EDID/серийнику.
- Трей-меню: пункт «Прочитать яркость» пер-монитор.
- Проверка: поддерживаемые мониторы возвращают значение; неподдерживаемые — аккуратная ошибка.
- Примечания:

## Этап 4. DDC: установка яркости (минимум) [TODO]
- В меню: «Яркость: - | + | Presets 25/50/75/100».
- Проверка: изменение реально применяется; есть возврат к прошлому значению.
- Примечания:

## Этап 5. Слайдеры и профили яркости [TODO]
- Слайдер в подменю каждого монитора; профили per-monitor в `~/.config/mondis/brightness.toml`.
- Проверка: сохранение/загрузка профилей, применение на один/несколько мониторов.
- Примечания:

## Этап 6. Раскладка экранов (X11) [TODO]
- Операции позиционирования: Left/Right/Above/Below относительно «основного»; «Сделать основным».
- Без drag-n-drop, только пресеты. Добавить «Откатить изменения» (таймер 15 сек).
- Проверка: корректное применение позиций; стабильный откат.
- Примечания:

## Этап 7. Масштабирование (X11 fractional scale) [TODO]
- Расчёт DPI по EDID, подбор scale (1.00, 1.25, 1.33, 1.50 ...). Команды `xrandr --scale SxS`.
- Пункт «Подогнать физический размер к основному».
- Проверка: близкий визуальный размер элементов на мониторах; надёжный откат.
- Примечания:

## Этап 8. Цветовая температура и каналы (DDC) [TODO]
- Пытаться VCP 0xE3 (цвет. температура) при наличии; иначе RGB (0x8C/0x92/0x93). Фолбэк: `xrandr --gamma`.
- Проверка: аппаратная температура на поддерживаемых; фолбэк на остальных с предупреждением.
- Примечания:

## Этап 9. Профили раскладки и авто-применение [TODO]
- Профили: геометрия, scale, яркость/цвет. Применение вручную и при событиях (подключение/отключение).
- Проверка: предсказуемость профилей; кнопка «Откат».
- Примечания:

## Этап 10. Доступы/права и диагностика [TODO]
- Чеклист: `i2c-dev`, права к `/dev/i2c-*`, группы `i2c/video`. Опция генерации udev-правил.
- Команда «Диагностика» (аналог `ddcutil environment`).
- Проверка: понятные сообщения об ошибках и шаги исправления.
- Примечания:

## Этап 11. Wayland (GNOME Mutter) — чтение [TODO]
- `mondis-wayland`: DBus `org.gnome.Mutter.DisplayConfig` через `zbus`. Read-only список выходов/режимов/scale.
- Проверка: корректное отображение в GNOME Wayland.
- Примечания:

## Этап 12. Wayland (GNOME Mutter) — применение [TODO]
- Применение позиций/масштабов через DisplayConfig (в рамках API).
- Проверка: настройки применяются, есть откат.
- Примечания:

## Этап 13. DDC через libddcutil (FFI) [TODO]
- Bindgen к `libddcutil`; safe wrapper; таймауты/ретраи; поддержка USB-мониторов.
- Проверка: паритет с CLI по функционалу, ускорение на сериях команд.
- Примечания:

## Этап 14. Завершение MVP и шлифовка [TODO]
- Автозапуск `.desktop`, иконки, локализация; снапшоты настроек, безопасный откат любых шагов; документация и FAQ.
- Проверка: ручной тест в GNOME/KDE/XFCE, разных моделях мониторов.
- Примечания:

---

### Горизонтальные требования и критерии качества
- Фиче-флаги для включения/выключения новых возможностей.
- Логи: подробные в `debug`, краткие в `info`; понятные ошибки для пользователя.
- Идемпотентность и откат: операции безопасны при повторе; всегда сохраняем «предыдущую» конфигурацию.
- Тесты: юнит (EDID, профили), интеграционные (сухие прогоны команд, сравнение с состоянием RandR/DBus).
- Риски: Wayland-ограничения (описать поддерживаемый объём); несовместимости DDC (таймауты, чёрные списки, фолбэк).

### Решения по стеку
- Трей: `tray-icon` или `ksni` (SNI/AppIndicator), для GNOME потребуется поддержка AppIndicator.
- X11: `x11rb` + RandR; EDID: `edid` crate.
- DDC: CLI `ddcutil` на старте; затем FFI к `libddcutil`.
- Wayland (позже): `zbus` (Mutter DisplayConfig), `wayland-client`/`smithay-client-toolkit` для wlroots в отдельной итерации.
- Конфиги: `serde` + `toml`; async: `tokio` для фоновых задач и CLI вызовов.
